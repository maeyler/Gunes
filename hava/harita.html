<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <link rel="icon" href="hava.png">
  <title>Hava Durumu </title>
  
  <style>
    body {
        max-width: 600px;
        margin: 0;
    }
    div {
        display: inline-block;
        box-sizing: border-box;
        padding: 8px;
        vertical-align: top;
    }
    p { margin: 0; }
    pre { overflow-x: hidden; }
    #durum { width: 45%; }
    #hesap { width: 52%; }
    #main {
        box-sizing: border-box;
        width: 100%;
        padding: 20px;
        text-align: center;    
        background: #9cf;
        font-size: 24px;
        margin: 0;
    }
    #yer { margin: 10px; }
    #err { color:red }
    #tarih { width: 125px; }
    #mahal { width: 200px; }
    .renkli { color:  blue; }
    #temkin {
        width: 100px;
        display: none;
        position: absolute;
        top: 220px;
        border: 1px solid;
        padding: 6px;
        background: #cff;
    }
    #map {
        height:300px; width:100%;
        box-sizing: border-box;
        border: 0;
    }
  </style>
</head>

<body>
<div id=main>
<p id=yer>location</p>
<p><img id=icon>
<span id=hava>weather</span></p>
</div>
<div id=durum>
  <b>Hava durumu</b>
  <pre id=detay>detail</pre>
</div>
<div>
  <b id=hesap>Güneş hesabı</b>
  <pre id=gunes>sunrise</pre>
  <pre id=temkin></pre>
</div>
<div id=err>API key gerekiyor: 
  <a href="https://openweathermap.org/appid" 
   target="NewTab">openweathermap.org</a> 
</div>
<hr />
<div id=map></div>
<hr />
<div>
    <!-- Gün <input id=tarih type=date min="2000-01-01" 
        onchange="setTime(value)"><br><br> -->
    Enlem/Boylam/Saat dilimi<br>
    <input id=mahal type=text value="41 29 +3">
    &emsp; <input id=sil type=button value=Sil
        onclick="out.innerText=''">
    &emsp; <input type=button value=Key
        onclick="replaceKey()"><br>
    <pre id=out class=renkli></pre>
</div>
<hr />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<!-- Make sure you put JS AFTER CSS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.geodesic"></script>
<script src="../saat/hesap.js"></script>
<script>
"use strict";
var MAP, marker, geodesic  //global
const Kabe = new Location(21.422500, 39.826137)
function initMap() {
    let p = {lat:41, lng:29} //initial coordinates
    console.log('init at', p)
    //L is global object from leaflet
    MAP = L.map('map').setView(p, 10)  //setZoom(10)
    marker = L.marker(p).addTo(MAP)
    let u = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
    let attribution = '&copy; OpenStreetMap contributors'
    L.tileLayer(u, {attribution}).addTo(MAP)
    const options = {weight:1, color:'red'}
    geodesic = new L.Geodesic([], options).addTo(MAP)
    // let report = () => out.innerText = MAP.getZoom()
    // MAP.on('zoom', report); report()
}
async function toJSON(url) {
    let r = await fetch(url)
    if (!r.ok) error(r.statusText)
    return r.json()
}
// Location
async function askLocation() {
    let name = 'geolocation'
    let result = await navigator.permissions.query({name})
    if (result.state == 'denied') {
        let url = "https://ipinfo.io/json"
        toJSON(url).then(getLocation2, error)
    } else  {
        navigator.geolocation
        .getCurrentPosition(getLocation1, error);
    }
}
function getLocation2(p) { //Approximate
    console.log("ipinfo.io", p.city)
    setLocation(p.loc, true)
}
function getLocation1(p) { //Accurate
    console.log("getCurrentPosition")
    let loc = p.coords.latitude+', '+p.coords.longitude
    setLocation(loc, true)
}
// Weather
var accessKey;
async function askWeather() {
    let {lat, lng} = G.loc; console.log(lat, lng)
    const U = "https://api.openweathermap.org/data/2.5/weather?"
    let url = U+"lat="+lat+"&lon="+lng+"&APPID="+accessKey;
    hava.innerText = "Hava durumu yükleniyor"
    let data = await toJSON(url)
    let w = data.weather[0]; showIcon(w.icon)
    let celsius = (data.main.temp - 273.15).toFixed(0)
    let hh = w.main+"  "+celsius+"°", {sys} = data
    let yy = data.name+', '+sys.country
    hava.innerText = hh; yer.innerText = yy
    console.log(yy, hh, data)
    lat = data.coord.lat; lng = data.coord.lon
    let loc = lat.toFixed(2)+", "+lng.toFixed(2)
    setLocation(loc+", "+data.timezone/3600, false)
    let wind = (3.6*data.wind.speed).toFixed(0)
    let pres = (0.750062*data.main.pressure).toFixed(0)
    const WIND = ['K','KD','D','GD','G','GB','B','KB','K']
    let d = (data.wind.deg/45).toFixed(0)
    detay.innerText = hh+'\n'+yy+'\n['+loc+"]"
        +'\nRuzgar '+wind+' km/h'
        +'\nYönü   '+data.wind.deg+'° '+WIND[d]
        +'\nBasınç '+pres+' mm'
        +'\nNem  %'+data.main.humidity
    let {sunrise, sunset} = sys, noon = (sunrise+sunset)/2
    out.innerText += '\n'+data.name+': '+G.loc
        + F.toHHMM(G.noon).padStart(7)
        + F.toHHMM(G.noon+G.half).padStart(7)
    gunes.innerHTML = 
           'Doğuş '+toHM(sunrise)+localHM(G.noon-G.half)
        +'\nÖğle  '+toHM(noon)   +localHM(G.noon)
        +'\nBatış '+toHM(sunset) +localHM(G.noon+G.half)
    +'\n\nSiyahlar APIden \n<span class=renkli>Maviler hesapla</span>'
    temkin.innerHTML = '<b>Diyanet</b>'
        +'\nGüneş '+ F.toHHMM(G.noon-G.half-6)
        +'\nÖğle  '+ F.toHHMM(G.noon+6)
        +'\nAkşam '+ F.toHHMM(G.noon+G.half+7)
    mahal.value = G.loc.toString()
}
function toHM(t) { // t in seconds -- convert to minutes
    //number of minutes since 1/1/1970, in local time
    //this.base = (J2000 + G.day.num)*1440 - G.loc.zone*60
    return F.toHHMM(((t + 3600*G.loc.zone)%86400)/60)
}
function localHM(m) { // m in minutes
    return '<span class=renkli>'
        +F.toHHMM(m).padStart(8)+'</span>'
}
function showIcon(i) {
    const URL = "https://openweathermap.org/img/w/"
    icon.src = URL+i+".png"
    // document.querySelector('link').href = icon.src
}
// Interaction
function askUser() {
    let k = prompt('Please enter openweather key:')
    if (!k) error('You need an API key')
    return k
}
function error(e) {
    main.style.display = "none"; //hide
    err.style.display = ''; //show
    throw e
}
function replaceKey() {
    let t = confirm('Do you want to replace API key?')
    if (t) getAPIkey(true)
}
function getAPIkey(forced) {
    if (origin.startsWith('http') && localStorage) {
        if (!localStorage.keys) localStorage.keys = '{}'
        let keys = JSON.parse(localStorage.keys)
        if (forced || !keys.openweather) {
           keys.openweather = askUser()
           localStorage.keys = JSON.stringify(keys)
        }
        accessKey = keys.openweather
    } else { //cannot use localStorage
        accessKey = askUser()
    }
}
// Calculation
function setTime(str) {
    G.setDay(Day.fromString(str))
    // tarih.value = G.day.str
    if (G.loc) out.innerText += '\n'+G
    console.log('setTime', G.day.toString())
}
function setLocation(str, update) {
    G.setLoc(Location.fromString(str))
    if (update) {
        askWeather(); marker.setLatLng(G.loc)
        geodesic.setLatLngs([G.loc, Kabe])
    }
}
hesap.innerText += ' '+VERSION
err.style.display = "none"
getAPIkey(); askLocation(); initMap()
setTime(new Date())
console.log(G)  //global
MAP.on('click', e => {
    let y = M.normal(e.latlng.lng)
    setLocation(e.latlng.lat+', '+y, true)
})
mahal.onkeyup = e => {
  let t = e.target
  if (e.keyCode === 13) {
      setLocation(t.value, true)
      MAP.setView(G.loc)
  }
  if (e.keyCode === 27) t.blur()
}
gunes.onmouseenter = () => {
    temkin.style.display = 'block'
}
gunes.onmouseleave = () => {
    temkin.style.display = ''
}

</script>

</body>
</html>
